input.onGesture(Gesture.Shake, function () {
    if (connected == 1) {
        if (command == "ACTIVE") {
            HIT = 1
            command = "END"
            basic.showIcon(IconNames.Skull)
        }
    }
})
bluetooth.onBluetoothDisconnected(function () {
    basic.showIcon(IconNames.SmallDiamond)
    connected = 0
})
bluetooth.onBluetoothConnected(function () {
    basic.showIcon(IconNames.Diamond)
    connected = 1
})
let timesinceACTIVE = 0
let connected = 0
let command = ""
let HIT = 0
bluetooth.startUartService()
HIT = 0
command = "WAIT"
connected = 0
basic.forever(function () {
    if (connected == 1) {
        command = bluetooth.uartReadUntil(serial.delimiters(Delimiters.NewLine))
        if (command == "RESET") {
            HIT = 0
            command = "WAIT"
        }
        if (command == "INFO") {
            if (HIT == 0) {
                bluetooth.uartWriteLine("MISS")
            } else {
                bluetooth.uartWriteLine("HIT")
            }
            command = "ACTIVE"
        }
        if (command == "BEGIN") {
            timesinceACTIVE = input.runningTime()
            command = "ACTIVE"
        }
        if (command == "ACTIVE") {
            basic.showIcon(IconNames.StickFigure)
            if (input.runningTime() - timesinceACTIVE >= 30000) {
                command = "WAIT"
            }
        }
        if (command == "WAIT" || command == "END") {
            timesinceACTIVE = input.runningTime()
            basic.showIcon(IconNames.No)
        }
    }
})
